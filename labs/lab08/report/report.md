---
## Front matter
title: "Отчёт по лабораторной работе 8"
subtitle: "Настройка SMTP-сервера"
author: "Элсаиед Адел"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию SMTP-сервера.

# Выполнение

## Установка и настройка почтового сервера Postfix

1. На виртуальной машине **server** выполнен вход под пользовательской учётной записью с последующим переходом в режим суперпользователя с помощью команды `sudo -i`. После получения прав администратора произведена установка необходимых пакетов Postfix и почтового клиента s-nail с использованием пакетного менеджера `dnf`.

   ![Установка Postfix и s-nail на сервере](Screenshot_1.png){ #fig:006 width=80% }

2. Для обеспечения работы почтового сервиса в межсетевом экране выполнено добавление службы SMTP. Служба разрешена как во временной конфигурации, так и на постоянной основе. Проверка активных сервисов подтвердила наличие SMTP в списке разрешённых.

3. С целью корректной работы служб в условиях включённого SELinux выполнено восстановление контекстов безопасности в каталоге `/etc` с помощью утилиты `restorecon`.

   ![Восстановление SELinux-контекстов](Screenshot_2.png){ #fig:008 width=80% }

4. Почтовая служба Postfix была добавлена в автозагрузку и запущена средствами systemd. Служба успешно инициализировалась и перешла в рабочее состояние.

   ![Запуск и включение Postfix](Screenshot_3.png){ #fig:009 width=80% }

## Изменение параметров Postfix с использованием postconf

1. Выполнен просмотр текущих параметров конфигурации Postfix. Отдельно проверены значения параметров `myorigin` и `mydomain`. Установлено, что доменное имя соответствует логину пользователя и домену `elsaiedadel.net`.

   ![Просмотр параметров Postfix](Screenshot_4.png){ #fig:010 width=80% }

2. Значение параметра `myorigin` было изменено на значение параметра `mydomain`. После изменения выполнена повторная проверка параметра, подтверждающая успешное применение настроек.

   ![Изменение параметра myorigin](Screenshot_5.png){ #fig:011 width=80% }

3. Выполнена проверка корректности конфигурации Postfix, после чего произведена перезагрузка конфигурационных файлов службы.

4. Просмотрены все параметры Postfix, отличающиеся от значений по умолчанию. Дополнительно задано фиксированное значение домена и отключена поддержка IPv6, оставив только протокол IPv4.

   ![Отключение IPv6 и проверка конфигурации](Screenshot_6.png){ #fig:012 width=80% }

## Проверка работы Postfix на сервере

1. Под пользовательской учётной записью на сервере выполнена отправка тестового письма самому себе с помощью утилиты mail. Сообщение успешно принято почтовой системой.

   ![Отправка тестового письма с сервера](Screenshot_7.png){ #fig:013 width=80% }

2. Анализ журнала `/var/log/maillog` показал, что письмо было успешно доставлено в локальный почтовый ящик, о чём свидетельствуют строки со статусом доставки в mailbox. Также в каталоге `/var/spool/mail` обнаружен файл пользователя с содержимым отправленного письма.

   ![Журнал доставки почты на сервере](Screenshot_8.png){ #fig:014 width=80% }

## Настройка и проверка клиента Postfix

1. На виртуальной машине **client** выполнен вход в систему с последующим переходом в режим суперпользователя. Установлены пакеты Postfix и s-nail, после чего отключена поддержка IPv6 и запущена почтовая служба.

   ![Установка и запуск на клиенте](Screenshot_9.png){ #fig:015 width=80% }

2. При первой попытке отправки письма с клиента сервер принимал соединение, однако доставка была невозможна из-за ограничений параметров сетевых интерфейсов и доверенных сетей.

3. На сервере выполнен просмотр параметров `inet_interfaces` и `mynetworks`. После этого Postfix был настроен на прослушивание всех сетевых интерфейсов и добавление внутренней сети `192.168.0.0/16` в список доверенных.

4. После перезагрузки конфигурации и перезапуска службы Postfix повторная отправка письма с клиента завершилась успешно. В журнале сервера зафиксировано принятие и доставка сообщения в локальный почтовый ящик пользователя.

   ![Успешная доставка письма с клиента](Screenshot_10.png){ #fig:016 width=80% }

## Конфигурация Postfix для доменного адреса и устранение ошибок доставки

1. С виртуальной машины **client** под пользовательской учётной записью выполнена попытка отправки почтового сообщения на доменный адрес вида `user@elsaiedadel.net`. После отправки сообщения произведена проверка очереди Postfix, в которой зафиксировано сообщение со статусом ожидания доставки и ошибкой подключения к SMTP-службе сервера.

   ![Сообщение в очереди Postfix и ошибка Connection refused](Screenshot_11.png){ #fig:017 width=80% }

2. На сервере выполнен анализ журнала `/var/log/maillog`. В журнале обнаружены записи, указывающие на отклонение сообщения и формирование уведомления о недоставке. Причиной являлась некорректная маршрутизация доменной почты, что подтверждается статусами `status=bounced` и `status=deferred`.

   ![Лог Postfix с ошибкой доставки доменной почты](Screenshot_12.png){ #fig:018 width=80% }

3. Для корректной обработки доменной почты выполнена настройка DNS. В файле прямой зоны домена `elsaiedadel.net` добавлена MX-запись, указывающая на почтовый сервер `mail.elsaiedadel.net`, а также A-запись для данного имени.

   ![Прямая DNS-зона с MX-записью](Screenshot_13.png){ #fig:019 width=80% }

4. Дополнительно выполнена настройка обратной DNS-зоны сети `192.168.1.0/24`. В зоне добавлены PTR-записи для сервера, клиента и почтового узла, что обеспечивает корректное обратное разрешение имён.

   ![Обратная DNS-зона с PTR-записями](Screenshot_14.png){ #fig:020 width=80% }

5. После внесения изменений файлы зон были сохранены, а временные файлы журналов удалены. В конфигурации Postfix добавлен домен в параметр `mydestination`, что определяет сервер как конечную точку доставки почты для данного домена.

6. Для применения изменений выполнена проверка конфигурации Postfix, перезагрузка службы Postfix, восстановление SELinux-контекстов для каталогов `/etc` и `/var/named`, а также перезапуск DNS-службы named.

   ![Применение изменений Postfix и DNS](Screenshot_15.png){ #fig:021 width=80% }

7. После перезапуска служб выполнена повторная обработка очереди сообщений. Ранее отложенные письма были успешно доставлены адресату, что подтверждается отсутствием сообщений в очереди и соответствующими записями в журнале.

   ![Успешная доставка доменной почты](Screenshot_16.png){ #fig:022 width=80% }

8. Проверка содержимого локального почтового ящика пользователя на сервере показала наличие письма, отправленного с клиента на доменный адрес. В заголовках сообщения зафиксировано корректное имя отправителя, получателя и почтового сервера.

   ![Полученное доменное письмо в почтовом ящике](Screenshot_17.png){ #fig:023 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальных машин

1. На виртуальной машине **server** выполнен переход в каталог `/vagrant/provision/server/`. Текущая конфигурация DNS-сервера была скопирована в каталог provision для последующего автоматического применения при развёртывании виртуальной машины.

   ![Копирование конфигурации DNS в provision](Screenshot_18.png){ #fig:024 width=80% }

2. В каталоге `/vagrant/provision/server` создан исполняемый файл `mail.sh`, предназначенный для автоматической установки и настройки почтового сервера Postfix. Файл содержит инструкции по установке пакетов, настройке firewall, конфигурации Postfix и перезапуску службы.

   ![Скрипт mail.sh для сервера](Screenshot_19.png){ #fig:025 width=80% }

3. Аналогичный скрипт `mail.sh` создан в каталоге `/vagrant/provision/client` для виртуальной машины **client**. Скрипт выполняет установку Postfix и s-nail, отключает IPv6 и запускает почтовую службу.

   ![Скрипт mail.sh для клиента](Screenshot_20.png){ #fig:026 width=80% }

4. Созданные provisioning-скрипты были предназначены для последующего подключения в файле `Vagrantfile`, что позволяет автоматически настраивать почтовую подсистему при запуске виртуальных машин server и client.

# Вывод

В ходе выполнения лабораторной работы была выполнена установка и настройка почтового сервера Postfix на виртуальных машинах server и client. Настроены основные параметры почтовой системы, обеспечивающие локальную и доменную доставку сообщений, выполнена конфигурация межсетевого экрана и корректировка параметров SELinux. Проведена проверка работы Postfix при отправке писем с сервера и клиента, а также устранены ошибки доставки, связанные с настройкой сетевых параметров и DNS. Дополнительно реализована автоматизация конфигурации почтовой подсистемы с использованием provisioning-скриптов, что обеспечивает воспроизводимость и упрощает развёртывание почтового сервера в виртуальной среде.

# Контрольные вопросы

**1. В каком каталоге и в каком файле следует смотреть конфигурацию Postfix?**  
Основная конфигурация Postfix располагается в каталоге `/etc/postfix`. Главным конфигурационным файлом является файл `main.cf`, в котором задаются основные параметры работы почтового сервера. Дополнительно для настройки сервисов используется файл `master.cf`.

**2. Каким образом можно проверить корректность синтаксиса в конфигурационном файле Postfix?**  
Для проверки корректности синтаксиса конфигурационных файлов Postfix используется команда `postfix check`. Она выполняет анализ настроек и сообщает о наличии ошибок или несоответствий в конфигурации.

**3. В каких параметрах конфигурации Postfix требуется внести изменения для настройки возможности отправки писем не на локальный хост, а на доменные адреса?**  
Для обеспечения отправки почты на доменные адреса необходимо изменить значения следующих параметров:
- `mydomain` — задаёт доменное имя почтового сервера;
- `myorigin` — определяет домен, добавляемый к исходящим письмам;
- `inet_interfaces` — задаёт интерфейсы, на которых Postfix принимает соединения;
- `mynetworks` — определяет список доверенных сетей;
- `mydestination` — указывает домены, для которых сервер является конечной точкой доставки почты.

**4. Приведите примеры работы с утилитой mail по отправке письма, просмотру имеющихся писем и удалению письма.**  
Отправка письма выполняется с помощью утилиты mail с указанием темы и адресата.  
Просмотр входящих писем осуществляется при запуске утилиты mail без параметров, после чего отображается список сообщений в почтовом ящике.  
Удаление письма выполняется из интерактивного режима mail путём указания номера сообщения и команды удаления, после чего изменения сохраняются при выходе из программы.

**5. Приведите примеры работы с утилитой postqueue.**  
Для просмотра очереди почтовых сообщений используется команда `postqueue -p`, которая отображает все письма, ожидающие доставки.  
Число сообщений в очереди определяется по количеству записей, выведенных данной командой.  
Для повторной отправки всех сообщений, находящихся в очереди, используется команда `postqueue -f`.  
Удаление конкретного письма из очереди выполняется по его идентификатору с использованием соответствующей команды управления очередью Postfix.
