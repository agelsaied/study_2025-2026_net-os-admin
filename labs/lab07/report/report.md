---
## Front matter
title: "Отчёт по лабораторной работе 7"
subtitle: "Расширенные настройки межсетевого экрана"
author: "Элсаиед Адел"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Получить навыки настройки межсетевого экрана в Linux в части переадресации портов и настройки Masquerading.

# Выполнение

## Создание пользовательской службы firewalld

1. В операционной системе Rocky Linux на виртуальной машине **server** выполнено создание пользовательского описания службы FirewallD на основе стандартной службы SSH. Для этого системный файл `/usr/lib/firewalld/services/ssh.xml` был скопирован в каталог пользовательских служб `/etc/firewalld/services/` под именем `ssh-custom.xml`. Данный подход позволяет изменять параметры службы без вмешательства в системные файлы, которые могут быть перезаписаны при обновлениях.

2. Выполнен просмотр содержимого файла `/etc/firewalld/services/ssh-custom.xml`. Файл представляет собой XML-описание службы, используемое FirewallD для определения правил доступа. Принцип синтаксиса файла:
   - строка `<?xml version="1.0" encoding="utf-8"?>` задаёт версию XML и используемую кодировку;
   - элемент `<service>` является корневым контейнером описания службы;
   - элемент `<short>` задаёт краткое имя службы (идентификатор/название, отображаемое в списках);
   - элемент `<description>` содержит развернутое текстовое описание назначения службы;
   - элемент `<port .../>` задаёт параметры сетевого доступа: протокол (`protocol="tcp"`) и номер порта (`port="22"` либо другой);
   - закрывающий тег `</service>` завершает описание службы.

   ![Просмотр содержимого ssh-custom.xml](Screenshot_1.png){ #fig:007 width=80% }

3. Файл `ssh-custom.xml` был открыт на редактирование. В описании службы был изменён порт SSH со стандартного `22` на `2022`, а также скорректировано описание службы для указания, что это модифицированная (пользовательская) версия службы SSH.

   ![Редактирование порта и описания службы](Screenshot_2.png){ #fig:008 width=80% }

4. Выполнен вывод списка активных служб FirewallD. На этом этапе пользовательская служба ещё не отображалась в активном списке, так как она не была загружена/активирована правилами межсетевого экрана.

5. Служба `ssh-custom` была добавлена в FirewallD и активирована. После временного добавления выполнено сохранение правила на постоянной основе и перезагрузка конфигурации межсетевого экрана, что обеспечивает сохранение настройки после перезапуска системы.

   ![Добавление ssh-custom и перезагрузка FirewallD](Screenshot_3.png){ #fig:010 width=80% }


## Перенаправление портов

1. На сервере настроено перенаправление входящих TCP-соединений с порта `2022` на стандартный SSH-порт `22`. Такая схема позволяет принимать подключения на нестандартный порт при сохранении работы службы SSH на стандартном порту внутри системы.

   ![Настройка port forward 2022 -> 22](Screenshot_4.png){ #fig:011 width=80% }

2. На клиентской машине выполнена проверка подключения к серверу по SSH через порт `2022`. Подключение установлено успешно, что подтверждает корректность настройки перенаправления портов и доступность службы.

   ![Проверка SSH-подключения через порт 2022](Screenshot_5.png){ #fig:012 width=80% }


## Настройка Port Forwarding и Masquerading

1. На сервере выполнена проверка параметров ядра, связанных с пересылкой пакетов (forwarding). По результатам проверки было установлено, что пересылка IPv4-пакетов отключена (значение `net.ipv4.ip_forward = 0`).

2. Для включения пересылки IPv4-пакетов создан конфигурационный файл `/etc/sysctl.d/90-forward.conf` с параметром `net.ipv4.ip_forward = 1`. После применения настроек параметр стал активным, что обеспечивает возможность маршрутизации пакетов через сервер.

3. Для обеспечения корректного выхода клиентов в сеть через сервер включён режим маскарадинга (NAT) для зоны `public`. После внесения изменений конфигурация FirewallD была перезагружена, что применило настройку на практике.

   ![Включение ip_forward и masquerading](Screenshot_6.png){ #fig:013 width=80% }

4. На клиентской машине выполнена проверка выхода в Интернет, что подтверждает корректную настройку пересылки IPv4-пакетов и маскарадинга.

   ![Проверка выхода в Интернет на клиенте](Screenshot_7.png){ #fig:014 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальной машины

1. В каталоге `/vagrant/provision/server/` подготовлена структура каталогов для хранения конфигурационных файлов FirewallD и sysctl, после чего в соответствующие подкаталоги были скопированы:
   - файл пользовательской службы FirewallD `ssh-custom.xml`;
   - файл настройки пересылки пакетов `/etc/sysctl.d/90-forward.conf`.
   Это обеспечивает переносимость конфигурации и возможность автоматического применения при развёртывании виртуальной машины.

   ![Подготовка каталогов и копирование конфигураций в provision](Screenshot_8.png){ #fig:015 width=80% }

2. В каталоге `/vagrant/provision/server/` создан скрипт `firewall.sh` и назначены права на выполнение. Скрипт предназначен для автоматизации настройки: копирует конфигурационные файлы в систему, активирует службу `ssh-custom`, настраивает перенаправление порта `2022` на `22`, включает маскарадинг, перезагружает FirewallD и восстанавливает контексты SELinux для каталога `/etc`.

   ![Содержимое скрипта firewall.sh](Screenshot_9.png){ #fig:016 width=80% }

3. Для выполнения сценария при старте виртуальной машины в файле `Vagrantfile` должен быть добавлен provisioning-блок, указывающий на запуск `provision/server/firewall.sh`. Это обеспечивает автоматическое применение сетевых настроек при каждом развёртывании окружения.

# Вывод

В ходе выполнения лабораторной работы была выполнена настройка пользовательских правил межсетевого экрана FirewallD на виртуальной машине server. Создано пользовательское описание службы SSH с изменённым номером порта, произведена активация службы и её интеграция в конфигурацию FirewallD. Реализовано перенаправление портов для доступа к службе SSH через нестандартный порт, а также выполнена настройка пересылки IPv4-пакетов и маскарадинга для обеспечения корректной маршрутизации сетевого трафика. Дополнительно была подготовлена автоматизация сетевых настроек с использованием provisioning-скрипта Vagrant, что обеспечивает воспроизводимость конфигурации при повторном развёртывании виртуальной машины. Проверка показала корректную работу настроенных сервисов, успешное подключение по SSH и доступ клиента к внешним сетевым ресурсам.

# Контрольные вопросы

**1. Где хранятся пользовательские файлы firewalld?**  
Пользовательские файлы конфигурации FirewallD, включая описания служб, хранятся в каталоге `/etc/firewalld/`. В частности, пользовательские файлы служб располагаются в подкаталоге `/etc/firewalld/services/`. В отличие от системных файлов, размещённых в `/usr/lib/firewalld/`, пользовательские файлы не перезаписываются при обновлении системы.

**2. Какую строку надо включить в пользовательский файл службы, чтобы указать порт TCP 2022?**  
Для указания TCP-порта 2022 в пользовательском файле службы необходимо добавить или изменить строку с описанием порта следующим образом:  
`<port protocol="tcp" port="2022"/>`

**3. Какая команда позволяет вам перечислить все службы, доступные в настоящее время на вашем сервере?**  
Для вывода списка всех служб, доступных в настоящий момент в FirewallD, используется команда:  
`firewall-cmd --get-services`

**4. В чем разница между трансляцией сетевых адресов (NAT) и маскарадингом (masquerading)?**  
NAT (Network Address Translation) — это общий механизм трансляции сетевых адресов, при котором один IP-адрес или диапазон адресов преобразуется в другой в соответствии с заданными правилами.  
Маскарадинг (masquerading) является частным случаем NAT и используется, как правило, при динамическом внешнем IP-адресе. При маскарадинге исходящий трафик автоматически подменяет исходный IP-адрес на адрес внешнего интерфейса сервера, что удобно для организации доступа клиентов в сеть Интернет без явного указания внешнего IP.

**5. Какая команда разрешает входящий трафик на порт 4404 и перенаправляет его в службу ssh по IP-адресу 10.0.0.10?**  
Для разрешения входящего TCP-трафика на порт 4404 и его перенаправления на SSH-службу (порт 22) узла с IP-адресом 10.0.0.10 используется команда:  
`firewall-cmd --add-forward-port=port=4404:proto=tcp:toport=22:toaddr=10.0.0.10`

**6. Какая команда используется для включения маскарадинга IP-пакетов для всех пакетов, выходящих в зону public?**  
Для включения маскарадинга IP-пакетов в зоне `public` применяется команда:  
`firewall-cmd --zone=public --add-masquerade --permanent`
