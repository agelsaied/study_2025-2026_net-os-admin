---
## Front matter
title: "Отчёт по лабораторной работе 11"
subtitle: "Настройка безопасного удалённого доступа по протоколу SSH"
author: "Элсаиед Адел"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по настройке удалённого доступа к серверу с помощью SSH.

# Выполнение

## Запрет удалённого доступа по SSH для пользователя root

1. На сервере для пользователя **root** был задан пароль (при необходимости) с переходом в привилегированный режим и выполнением процедуры установки пароля. Это обеспечивает возможность парольной аутентификации root в случае, если она разрешена настройками SSH-сервера.

2. В дополнительном терминале на сервере был запущен мониторинг системных событий и сообщений службы SSH для отслеживания попыток удалённого входа, а также причин успешной или неуспешной аутентификации.

3. С клиентской машины выполнена попытка подключения к серверу по SSH под пользователем **root**. В процессе аутентификации в системном журнале сервера зафиксированы сообщения о неуспешной проверке пароля и отказе во входе. Это указывает на то, что SSH-сервер принял соединение, запросил учётные данные, однако аутентификация не была успешно завершена.

   ![Попытка входа по SSH под root до запрета (сообщения journalctl)](Screenshot_3.png){ #fig:006 width=80% }

4. Для запрета удалённого входа пользователю **root** на сервере был открыт файл конфигурации SSH-сервера `/etc/ssh/sshd_config`, в котором установлен параметр `PermitRootLogin no`. Данная настройка запрещает удалённый вход под пользователем root независимо от используемого способа аутентификации.

   ![Запрет входа root через PermitRootLogin no](Screenshot_2.png){ #fig:007 width=80% }

5. После сохранения изменений служба SSH была перезапущена для применения новой конфигурации.

6. После запрета входа root повторно выполнена попытка подключения с клиента под пользователем **root**. В журнале сервера зафиксировано завершение соединения на этапе предварительной аутентификации и сообщения о неуспешных попытках входа. Это соответствует штатному поведению SSH-сервера при запрете удалённого входа пользователя root.

   ![Попытка входа root после запрета PermitRootLogin](Screenshot_1.png){ #fig:008 width=80% }

## Ограничение списка пользователей для удалённого доступа по SSH

7. С клиентской машины выполнена проверка подключения по SSH под пользователем **elsaiedadel**. Подключение прошло успешно: сервер запросил пароль, после его ввода была открыта интерактивная пользовательская сессия.

   ![Успешное SSH-подключение пользователя elsaiedadel до ограничения](Screenshot_4.png){ #fig:009 width=80% }

8. На сервере в файле конфигурации `/etc/ssh/sshd_config` добавлено ограничение списка пользователей с помощью параметра `AllowUsers vagrant`. После сохранения конфигурации служба SSH была перезапущена. Данная настройка разрешает удалённый доступ только пользователю `vagrant`, а все остальные подключения отклоняются.

   ![Ограничение доступа по SSH параметром AllowUsers vagrant](Screenshot_5.png){ #fig:010 width=80% }

9. После введения ограничения выполнена повторная попытка подключения по SSH под пользователем **elsaiedadel**. Соединение завершилось отказом с сообщением об отсутствии прав доступа, так как данный пользователь не был указан в списке разрешённых.

   ![Отказ в доступе пользователю elsaiedadel при AllowUsers vagrant](Screenshot_6.png){ #fig:011 width=80% }

10. Для восстановления доступа пользователя **elsaiedadel** в конфигурации SSH-сервера выполнено изменение параметра `AllowUsers` с добавлением данного пользователя в список разрешённых. После сохранения файла служба SSH была перезапущена.

   ![Добавление пользователя elsaiedadel в AllowUsers](Screenshot_7.png){ #fig:012 width=80% }

11. После обновления списка разрешённых пользователей повторно выполнена попытка подключения по SSH под пользователем **elsaiedadel**. Подключение прошло успешно, что подтверждает корректность применённых ограничений и восстановление доступа для указанного пользователя. Дополнительно отображено уведомление о количестве неудачных попыток входа с момента предыдущего успешного подключения.

   ![Успешное SSH-подключение после добавления в AllowUsers](Screenshot_8.png){ #fig:013 width=80% }

## Изменение порта службы SSH на 2022

12. На сервере в файле `/etc/ssh/sshd_config` выполнена попытка изменения порта службы SSH. В конфигурации была задана строка с некорректным значением порта (параметр `Port` был указан в неверном формате), что привело к ошибке применения конфигурации при перезапуске службы.

   ![Некорректная настройка параметра Port в sshd_config](Screenshot_9.png){ #fig:014 width=80% }

13. После сохранения конфигурации выполнен перезапуск `sshd`, однако служба не запустилась. В выводе `systemctl` зафиксировано завершение процесса sshd с ошибкой (`status=255/EXCEPTION`), что соответствует ошибке чтения/применения конфигурации.

   ![Сбой перезапуска sshd из-за ошибки конфигурации](Screenshot_10.png){ #fig:015 width=80% }

14. Для корректного переноса SSH на порт **2022** выполнены дополнительные настройки безопасности:
   - для SELinux добавлено разрешение использования порта 2022 службой SSH через назначение контекста `ssh_port_t`;
   - в `firewalld` открыт порт `2022/tcp` (временно и постоянно);
   - файл `/etc/ssh/sshd_config` исправлен (параметр `Port` задан корректно отдельной строкой), после чего `sshd` успешно перезапущен.
   В статусе службы подтверждено состояние `active (running)`, а в журнале видно, что демон слушает порт **2022** (и также остаётся активным стандартный порт **22**, так как он указан отдельной строкой).

   ![Настройка SELinux и firewalld для порта 2022 и успешный запуск sshd](Screenshot_11.png){ #fig:016 width=80% }

15. С клиентской машины выполнена проверка подключения:
   - подключение по умолчанию (без указания порта) выполняется на стандартный порт **22** и проходит успешно;
   - подключение с явным указанием порта `-p2022` также проходит успешно.
   Это подтверждает, что сервер принимает SSH-соединения одновременно на двух портах (22 и 2022), что соответствует конфигурации с двумя директивами `Port`.

   ![Проверка SSH-подключения на портах 22 и 2022](Screenshot_12.png){ #fig:017 width=80% }

## Настройка удалённого доступа по SSH по ключу

16. На сервере в конфигурации `/etc/ssh/sshd_config` включена аутентификация по ключу установкой параметра `PubkeyAuthentication yes`. Также подтверждено, что ранее применённые ограничения безопасности остаются активными (запрет root-входа и ограничение списка пользователей через `AllowUsers`). После сохранения файла выполнен перезапуск `sshd` для применения настроек.

   ![Разрешение PubkeyAuthentication yes в sshd_config](Screenshot_13.png){ #fig:018 width=80% }

17. На клиентской машине сформирована пара ключей SSH, после чего открытый ключ скопирован на сервер для пользователя **elsaiedadel** с помощью `ssh-copy-id`. Далее выполнено повторное подключение к серверу: аутентификация прошла без запроса пароля, что подтверждает корректную установку ключа в `~/.ssh/authorized_keys` и работу ключевой аутентификации.

   ![Копирование ключа на сервер и вход без пароля](Screenshot_14.png){ #fig:019 width=80% }

## Организация SSH-туннелей и перенаправление TCP-портов

18. На клиентской машине выполнена проверка активных TCP-соединений и слушающих сокетов. Затем организовано перенаправление порта: удалённый порт **80** на сервере перенаправлен на локальный порт **8080** с использованием SSH-туннеля в фоновом режиме. После настройки туннеля повторная проверка TCP-сокетов показала:
   - наличие SSH-соединения в состоянии `ESTABLISHED`;
   - появление локального слушающего порта `localhost:webcache (LISTEN)`, что соответствует локальному порту **8080** (служба/алиас может отображаться как `webcache`).
   Таким образом подтверждено, что локальный порт 8080 открыт процессом SSH и обслуживает туннель до удалённого веб-сервиса.

   ![Состояние TCP-соединений до и после создания SSH-туннеля 8080->80](Screenshot_15.png){ #fig:020 width=80% }

19. В браузере на клиентской машине открыт адрес `localhost:8080`. Отображена страница приветствия веб-сервера, обслуживаемого на стороне сервера, что подтверждает работоспособность туннеля и корректное перенаправление TCP-порта.

   ![Проверка туннеля в браузере: страница Welcome через localhost:8080](Screenshot_16.png){ #fig:021 width=80% }

## Запуск консольных приложений через SSH

20. С клиентской машины выполнен удалённый запуск консольных команд на сервере без открытия интерактивной сессии:
   - получено имя узла сервера через выполнение `hostname`;
   - выведен список файлов домашнего каталога пользователя командой `ls -Al`;
   - выполнен запуск почтового клиента с указанием переменной окружения `MAIL=~/Maildir/`, в результате отображён список сообщений.
   Это демонстрирует возможность выполнять на сервере отдельные команды по SSH и получать их вывод в терминал клиента.

   ![Удалённый запуск команд hostname, ls и mail через SSH](Screenshot_17.png){ #fig:022 width=80% }

## Запуск графических приложений через SSH (X11 Forwarding)

21. На сервере в конфигурационном файле `/etc/ssh/sshd_config` была разрешена передача графического интерфейса X11 путём установки параметра `X11Forwarding yes`. Дополнительно подтверждено, что остальные параметры безопасности SSH (запрет входа root, ограничение пользователей, аутентификация по ключу, настройка портов) сохранены без изменений.

   ![Разрешение X11Forwarding в sshd_config](Screenshot_18.png){ #fig:023 width=80% }

22. После сохранения изменений служба SSH была перезапущена для применения обновлённой конфигурации и активации поддержки X11 Forwarding.

23. С клиентской машины выполнена попытка удалённого запуска графического приложения Firefox на сервере с использованием SSH-подключения с поддержкой X11. При попытке запуска в терминале клиента были выведены сообщения об ошибке, указывающие на отсутствие переменной окружения DISPLAY и невозможность установить X11-соединение. Это свидетельствует о том, что на клиентской стороне отсутствует или не запущен X-сервер, либо не настроено окружение для приёма X11-перенаправления.

   ![Ошибка запуска графического приложения по SSH из-за отсутствия DISPLAY](Screenshot_19.png){ #fig:024 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальной машины

24. На виртуальной машине **server** выполнен переход в каталог `/vagrant/provision/server`, предназначенный для хранения файлов автоматической инициализации. Внутри него создана иерархия каталогов `ssh/etc/ssh`, в которую скопирован актуальный конфигурационный файл `sshd_config`. Это обеспечивает хранение эталонной версии конфигурации SSH в проекте Vagrant.

   ![Копирование sshd_config в каталог provision/server/ssh](Screenshot_20.png){ #fig:025 width=80% }

25. В каталоге `/vagrant/provision/server` создан исполняемый файл `ssh.sh`, предназначенный для автоматической настройки SSH-сервера при запуске виртуальной машины. Файлу были назначены права на выполнение, после чего он открыт на редактирование.

26. В файл `ssh.sh` внесён provisioning-скрипт, выполняющий следующие действия при загрузке виртуальной машины:
   - копирование конфигурационных файлов SSH из каталога provision в системный каталог `/etc`;
   - восстановление контекстов безопасности SELinux;
   - настройку firewall для разрешения TCP-порта 2022;
   - добавление порта 2022 в контексты SELinux для службы SSH;
   - перезапуск службы sshd для применения всех изменений.

   ![Provisioning-скрипт ssh.sh для автоматической настройки SSH](Screenshot_21.png){ #fig:026 width=80% }

27. Для автоматического выполнения созданного provisioning-скрипта во время загрузки виртуальной машины **server** в конфигурационный файл `Vagrantfile` был добавлен shell-provisioner с указанием пути к файлу `provision/server/ssh.sh` и сохранением порядка выполнения. Это гарантирует, что все настройки SSH, firewall и SELinux применяются автоматически при инициализации окружения без ручного вмешательства.

# Вывод

В ходе выполнения лабораторной работы была выполнена комплексная настройка службы SSH на сервере Rocky Linux. Реализованы меры по повышению безопасности удалённого доступа: запрещён вход по SSH для пользователя root, ограничен список пользователей, разрешённых для подключения, настроена аутентификация по ключам, изменён стандартный порт SSH и обеспечена его корректная работа с учётом требований SELinux и межсетевого экрана. Дополнительно были рассмотрены возможности SSH по организации туннелей, перенаправлению TCP-портов, запуску консольных и графических приложений, а также автоматизации конфигурации SSH с использованием provisioning-скриптов в среде Vagrant. Проведённые проверки подтвердили корректную работу всех настроек и практическую применимость SSH как универсального инструмента администрирования удалённых систем.

# Контрольные вопросы

**1. Вы хотите запретить удалённый доступ по SSH на сервер пользователю root и разрешить доступ пользователю alice. Как это сделать?**  
Для запрета удалённого доступа пользователю root в конфигурационном файле `/etc/ssh/sshd_config` необходимо установить параметр `PermitRootLogin no`. Для разрешения доступа пользователю alice следует либо явно указать его в параметре `AllowUsers alice`, либо убедиться, что данный параметр отсутствует или не ограничивает список пользователей. После внесения изменений требуется перезапустить службу sshd для применения новой конфигурации.

**2. Как настроить удалённый доступ по SSH через несколько портов? Для чего это может потребоваться?**  
Для настройки доступа по SSH через несколько портов в файле `sshd_config` необходимо указать несколько директив `Port`, каждая из которых задаёт отдельный порт, например стандартный 22 и дополнительный 2022. Такая настройка может потребоваться для повышения безопасности, обхода сетевых ограничений, организации плавного перехода на новый порт без прерывания доступа или для разграничения типов подключений.

**3. Какие параметры используются для создания туннеля SSH, когда команда ssh устанавливает фоновое соединение и не ожидает какой-либо конкретной команды?**  
Для создания такого туннеля используются параметры `-f`, `-N` и `-L`. Ключ `-f` переводит SSH-соединение в фоновый режим, `-N` указывает не выполнять удалённую команду, а `-L` задаёт правило локальной переадресации портов. Совместное использование этих параметров позволяет организовать туннель без интерактивной сессии.

**4. Как настроить локальную переадресацию с локального порта 5555 на порт 80 сервера server2.example.com?**  
Локальная переадресация настраивается указанием правила перенаправления, в котором локальный порт 5555 связывается с портом 80 сервера server2.example.com. В результате все обращения к локальному порту 5555 на клиентской машине будут передаваться по SSH-туннелю на веб-сервер, работающий на удалённом узле.

**5. Как настроить SELinux, чтобы позволить SSH связываться с портом 2022?**  
Для этого необходимо добавить порт 2022 в контекст безопасности `ssh_port_t`, используемый службой SSH. Таким образом SELinux будет считать данный порт допустимым для работы sshd и не будет блокировать соединения на нём.

**6. Как настроить межсетевой экран на сервере, чтобы разрешить входящие подключения по SSH через порт 2022?**  
В конфигурации межсетевого экрана требуется разрешить входящие TCP-соединения на порт 2022. Для этого порт добавляется в список разрешённых как временно, так и на постоянной основе, после чего межсетевой экран начинает пропускать SSH-подключения через указанный порт.
