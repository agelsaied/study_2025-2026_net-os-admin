---
## Front matter
title: "Отчёт по лабораторной работе 3"
subtitle: "Настройка DHCP-сервера"
author: "Элсаиед Адел"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию DHCPсервера.

# Выполнение

## Установка и конфигурирование DHCP-сервера на базе Kea

1. После загрузки операционной системы выполнен переход в рабочий каталог проекта `/var/tmp/user_name/vagrant`, после чего произведён запуск виртуальной машины **server** с использованием Vagrant. Виртуальная машина успешно инициализирована и загружена.

2. На виртуальной машине **server** выполнен вход под пользовательской учётной записью и осуществлён переход в режим суперпользователя с помощью команды `sudo -i` для выполнения административных операций.

3. Выполнена установка DHCP-сервера Kea с использованием менеджера пакетов DNF командой `dnf -y install kea`. В ходе установки были автоматически разрешены и установлены все необходимые зависимости. Процесс установки завершился успешно.

   ![Установка DHCP-сервера Kea](Screenshot_1.png){ #fig:001 width=80% }

4. В целях обеспечения возможности отката конфигурации выполнено резервное копирование исходного конфигурационного файла DHCP-сервера `/etc/kea/kea-dhcp4.conf` с добавлением временной метки к имени файла.

5. Произведено редактирование файла `/etc/kea/kea-dhcp4.conf`. В конфигурации сервера были заданы параметры DNS, передаваемые клиентам:  
   – в качестве DNS-сервера указан адрес `192.168.1.1`;  
   – задано доменное имя и домен поиска `elsaiedadel.net`.

   ![Настройка параметров DNS в kea-dhcp4.conf](Screenshot_2.png){ #fig:002 width=80% }

6. На основе шаблона, приведённого в конфигурационном файле, выполнена настройка подсети DHCP. Указана подсеть `192.168.1.0/24`, диапазон адресов для выдачи клиентам `192.168.1.30 – 192.168.1.199`, а также адрес маршрутизатора `192.168.1.1`. Все остальные примеры конфигураций подсетей были удалены.

   ![Конфигурация DHCP-подсети](Screenshot_3.png){ #fig:003 width=80% }

7. В конфигурационном файле DHCP-сервера выполнена привязка службы Kea DHCPv4 к сетевому интерфейсу `eth1`, что обеспечивает обслуживание запросов DHCP только на данном интерфейсе виртуальной машины **server**.

8. С использованием утилиты `kea-dhcp4 -t /etc/kea/kea-dhcp4.conf` выполнена проверка корректности конфигурационного файла. Ошибок синтаксиса и логических ошибок не выявлено.

9. В файле прямой DNS-зоны `/var/named/master/fz/elsaiedadel.net` добавлена запись для DHCP-сервера вида `dhcp A 192.168.1.1`. Также в файле обратной зоны `/var/named/master/rz/192.168.1` добавлена PTR-запись, сопоставляющая IP-адрес имени `dhcp.elsaiedadel.net`. В обоих файлах обновлён серийный номер зоны в соответствии с текущей датой.

   ![Настройка прямой DNS-зоны](Screenshot_4.png){ #fig:004 width=80% }  
   ![Настройка обратной DNS-зоны](Screenshot_5.png){ #fig:005 width=80% }

10. Выполнен перезапуск службы DNS-сервера named для применения внесённых изменений. После перезапуска проверена доступность DHCP-сервера по имени с использованием команды `ping dhcp.elsaiedadel.net`. Имя успешно разрешается, пакеты передаются без потерь.

   ![Проверка разрешения имени DHCP-сервера](Screenshot_6.png){ #fig:006 width=80% }

11. В конфигурации межсетевого экрана узла **server** разрешена работа службы DHCP. Сервис `dhcp` добавлен в список разрешённых, а также зафиксирован в постоянной конфигурации firewall.

12. Для предотвращения возможных ошибок, связанных с политиками безопасности, выполнено восстановление контекста безопасности SELinux для каталогов `/etc`, `/var/named` и `/var/lib/kea`.

13. В дополнительном терминале запущен мониторинг системных сообщений в реальном времени с помощью команды `tail -f /var/log/messages`. В основном терминале выполнен запуск DHCP-сервера командой `systemctl start kea-dhcp4.service`. Служба Kea DHCPv4 успешно запущена, ошибок в системных журналах не зафиксировано.

   ![Запуск DHCP-сервера Kea](Screenshot_7.png){ #fig:007 width=80% }

## Анализ работы DHCP-сервера

1. Перед запуском виртуальной машины **client** в рабочем каталоге проекта выполнен переход в подкаталог `vagrant/provision/client`, после чего создан provisioning-скрипт `01-routing.sh`. Файлу были назначены права на исполнение. Данный скрипт предназначен для настройки маршрутизации сетевых интерфейсов на стороне клиента.

2. В файле `01-routing.sh` задана конфигурация NetworkManager, обеспечивающая использование интерфейса `eth1` в качестве основного шлюза по умолчанию. Для интерфейса `eth0` отключено использование маршрута по умолчанию как для IPv4, так и для IPv6. После внесения изменений выполнен перезапуск соответствующих сетевых соединений.

   ![Provisioning-скрипт настройки маршрутизации client](Screenshot_8.png){ #fig:008 width=80% }

3. В файле `Vagrantfile` в разделе конфигурации виртуальной машины **client** выполнено подключение созданного provisioning-скрипта `01-routing.sh` с параметрами принудительного выполнения при каждом запуске. После этого произведён запуск виртуальной машины client с применением provisioning-конфигурации.

4. После загрузки виртуальной машины **client** на стороне сервера в системных журналах и файле `/var/lib/kea/kea-leases4.csv` зафиксированы события выдачи IP-адреса клиенту. DHCP-сервер успешно назначил клиенту адрес из заданного диапазона `192.168.1.30–192.168.1.199`.

5. На виртуальной машине **client** выполнена команда `ifconfig` для анализа состояния сетевых интерфейсов.  
   – интерфейс `eth1` получил IP-адрес `192.168.1.30`, маску подсети `255.255.255.0` и широковещательный адрес `192.168.1.255`, что подтверждает корректную работу DHCP-сервера;  
   – интерфейс `eth0` активен, однако не используется для маршрутизации трафика по умолчанию;  
   – интерфейс `lo` используется для локального взаимодействия внутри системы.

   ![Сетевые интерфейсы виртуальной машины client](Screenshot_9.png){ #fig:009 width=80% }

6. На виртуальной машине **server** выполнен просмотр файла `/var/lib/kea/kea-leases4.csv`, содержащего сведения о выданных DHCP-арендах.  
   В записи указаны:  
   – IP-адрес клиента `192.168.1.30`;  
   – MAC-адрес клиентского интерфейса;  
   – идентификатор клиента;  
   – время аренды и время истечения;  
   – идентификатор подсети и пула адресов.  
   Данная информация подтверждает корректную выдачу и учёт IP-адресов DHCP-сервером Kea.

   ![Файл аренды DHCP kea-leases4.csv](Screenshot_10.png){ #fig:010 width=80% }

## Настройка обновления DNS-зоны с использованием DHCP-DDNS

1. На виртуальной машине **server** выполнено создание каталога `/etc/named/keys`, предназначенного для хранения TSIG-ключей. С помощью утилиты `tsig-keygen` с алгоритмом `HMAC-SHA512` был сгенерирован ключ `DHCP_UPDATER`, используемый для аутентификации динамических обновлений DNS-зон. Сгенерированный ключ сохранён в файле `/etc/named/keys/dhcp_updater.key`.

   ![Генерация TSIG-ключа DHCP_UPDATER](Screenshot_11.png){ #fig:011 width=80% }

2. Проверено содержимое файла `/etc/named/keys/dhcp_updater.key`, содержащего имя ключа, используемый алгоритм шифрования и секретное значение. Данный ключ будет применяться как DNS-сервером Bind, так и DHCP-сервером Kea.

3. Для обеспечения корректного доступа DNS-сервера к ключу выполнена настройка прав доступа на каталог `/etc/named/keys`, установив владельца и группу `named:named`.

4. В основной конфигурационный файл DNS-сервера `/etc/named.conf` подключён файл с TSIG-ключом с помощью директивы `include`, что позволяет использовать данный ключ при обработке запросов динамического обновления зон.

5. В конфигурации DNS-зон сервера Bind выполнено разрешение динамических обновлений. Для прямой зоны `elsaiedadel.net` и обратной зоны `1.168.192.in-addr.arpa` в секциях `update-policy` добавлены правила, разрешающие обновление A- и PTR-записей с использованием ключа `DHCP_UPDATER`.

   ![Настройка update-policy для DNS-зон](Screenshot_12.png){ #fig:012 width=80% }

6. Выполнена проверка корректности конфигурации DNS-сервера с использованием команды `named-checkconf`. Ошибок конфигурации не выявлено, после чего DNS-сервер был перезапущен для применения изменений.

7. Для DHCP-сервера Kea создан файл `/etc/kea/tsig-keys.json`, в который перенесён ранее сгенерированный TSIG-ключ в формате JSON. Файл содержит имя ключа, алгоритм шифрования и секретное значение.

   ![TSIG-ключ в формате JSON для Kea](Screenshot_13.png){ #fig:013 width=80% }

8. Для файла `/etc/kea/tsig-keys.json` назначены корректные права доступа и владелец `kea:kea`, что обеспечивает безопасность хранения секретных данных.

9. Выполнено редактирование конфигурационного файла `/etc/kea/kea-dhcp-ddns.conf`. В файле задан адрес и порт службы DHCP-DDNS, подключён файл с TSIG-ключами, а также настроены параметры динамического обновления прямой и обратной DNS-зон `elsaiedadel.net.` и `1.168.192.in-addr.arpa.`. Имена зон указаны с завершающей точкой, что является обязательным условием корректной работы DDNS.

   ![Конфигурация DHCP-DDNS в Kea](Screenshot_14.png){ #fig:014 width=80% }

10. Для файла конфигурации DHCP-DDNS назначен владелец `kea:kea`. С использованием команды `kea-dhcp-ddns -t` выполнена проверка конфигурационного файла на наличие синтаксических ошибок. Проверка завершилась успешно.

11. Служба DHCP-DDNS была добавлена в автозагрузку и запущена с помощью команды `systemctl enable --now kea-dhcp-ddns.service`. Проверка состояния службы показала, что она успешно запущена и функционирует в штатном режиме.

   ![Состояние службы kea-dhcp-ddns](Screenshot_15.png){ #fig:015 width=80% }

12. В конфигурационный файл DHCP-сервера `/etc/kea/kea-dhcp4.conf` добавлены параметры, разрешающие динамическое обновление DNS-записей. Включена поддержка DDNS, задан домен `elsaiedadel.net` в качестве квалифицирующего суффикса и разрешено переопределение обновлений, инициируемых клиентами.

   ![Настройка DDNS в kea-dhcp4.conf](Screenshot_16.png){ #fig:016 width=80% }

13. Выполнена проверка конфигурационного файла DHCP-сервера с использованием утилиты `kea-dhcp4 -t`, после чего DHCP-сервер был перезапущен. Проверка статуса службы подтвердила её успешную работу.

   ![Состояние службы kea-dhcp4](Screenshot_17.png){ #fig:017 width=80% }

14. На виртуальной машине **client** выполнено переполучение IP-адреса путём перезапуска сетевого соединения `eth1`. В результате DHCP-сервер автоматически инициировал динамическое обновление DNS-записей.

15. В каталоге прямой DNS-зоны `/var/named/master/fz` автоматически создан файл журнала `elsaiedadel.net.jnl`, подтверждающий успешную работу механизма динамического обновления DNS-зоны.

## Анализ работы DHCP-сервера после настройки обновления DNS-зоны

1. На виртуальной машине **client** под пользовательской учётной записью выполнена проверка наличия DNS-записи, автоматически созданной DHCP-сервером с использованием механизма DDNS. Для этого применена утилита `dig` с указанием DNS-сервера `192.168.1.1` и имени узла `client.elsaiedadel.net`.

   ![Проверка DNS-записи клиента с помощью dig](Screenshot_18.png){ #fig:018 width=80% }

2. В выводе команды `dig` проанализированы основные секции ответа:  
   – в заголовке ответа указан статус `NOERROR`, что свидетельствует об успешной обработке DNS-запроса;  
   – флаг `aa` подтверждает, что ответ получен от авторитетного DNS-сервера;  
   – в секции `QUESTION` содержится запрос на получение A-записи для имени `client.elsaiedadel.net`;  
   – в секции `ANSWER` возвращена A-запись, сопоставляющая имя `client.elsaiedadel.net` IP-адресу `192.168.1.30`;  
   – в строке `SERVER` указан DNS-сервер `192.168.1.1`, обработавший запрос.  
   Полученный результат подтверждает корректную работу динамического обновления прямой DNS-зоны.

## Внесение изменений в настройки внутреннего окружения виртуальной машины server

3. На виртуальной машине **server** выполнен переход в каталог `/vagrant/provision/server`, после чего создан подкаталог `dhcp/etc/kea`, предназначенный для хранения конфигурационных файлов DHCP-сервера. В указанный каталог скопированы актуальные конфигурационные файлы Kea из `/etc/kea`.

4. Выполнено обновление конфигурационных файлов DNS-сервера. В каталог `/vagrant/provision/server/dns/var/named` скопировано содержимое каталога `/var/named`, а в каталог `/vagrant/provision/server/dns/etc/named` — содержимое `/etc/named`. При копировании подтверждена перезапись существующих файлов.

   ![Копирование конфигурации DNS и DHCP](Screenshot_19.png){ #fig:019 width=80% }

5. В каталоге `/vagrant/provision/server` создан исполняемый provisioning-скрипт `dhcp.sh`, предназначенный для автоматизации установки и настройки DHCP-сервера. В скрипт включены команды установки пакета Kea, копирования конфигурационных файлов, настройки прав доступа, восстановления контекста SELinux, конфигурации межсетевого экрана и запуска служб `kea-dhcp4` и `kea-dhcp-ddns`.

   ![Provisioning-скрипт dhcp.sh](Screenshot_20.png){ #fig:020 width=80% }

6. Созданный скрипт `dhcp.sh` по своей функциональности полностью воспроизводит ранее выполненные вручную действия по установке и настройке DHCP-сервера, что позволяет автоматически применять конфигурацию при развёртывании виртуальной машины **server**.

7. Для автоматического выполнения скрипта при запуске виртуальной машины **server** в файле `Vagrantfile` в разделе конфигурации сервера добавлен provisioning-блок, указывающий путь к скрипту `provision/server/dhcp.sh` и порядок его выполнения.

8. После внесения всех изменений виртуальные машины **client** и **server** были корректно остановлены. Настройка внутреннего окружения завершена, конфигурация готова к повторному развёртыванию с использованием Vagrant.

# Вывод

В ходе выполнения лабораторной работы была выполнена установка, настройка и анализ работы DHCP-сервера на базе Kea в виртуальной среде, развёрнутой с использованием Vagrant и VirtualBox. Реализована настройка DHCP для автоматической выдачи сетевых параметров клиентам, выполнена интеграция DHCP-сервера с DNS-сервером Bind с применением механизма динамического обновления DNS-зон (DDNS). Проведён анализ работы DHCP и DDNS на стороне клиента и сервера, подтверждена корректная выдача IP-адресов и автоматическое создание DNS-записей. Дополнительно выполнена автоматизация конфигурации серверного окружения с использованием provisioning-скриптов, что обеспечивает воспроизводимость и упрощает развёртывание сетевой инфраструктуры.

# Контрольные вопросы

**1. В каких файлах хранятся настройки сетевых подключений?**  
В современных дистрибутивах Linux настройки сетевых подключений, как правило, хранятся в конфигурационных файлах NetworkManager. Основные файлы находятся в каталоге `/etc/NetworkManager/system-connections/`, где каждое сетевое подключение описывается отдельным файлом. Также часть глобальных параметров NetworkManager может быть задана в файле `/etc/NetworkManager/NetworkManager.conf`. В более старых системах настройки могли храниться в файлах `/etc/sysconfig/network-scripts/ifcfg-*`.

**2. За что отвечает протокол DHCP?**  
Протокол DHCP (Dynamic Host Configuration Protocol) предназначен для автоматической конфигурации сетевых параметров узлов в IP-сети. Он обеспечивает динамическую выдачу клиентам IP-адресов, маски подсети, адреса шлюза по умолчанию, DNS-серверов и других сетевых параметров, исключая необходимость ручной настройки каждого узла.

**3. Поясните принцип работы протокола DHCP. Какими сообщениями обмениваются клиент и сервер, используя протокол DHCP?**  
Работа протокола DHCP основана на модели «клиент–сервер» и включает последовательность обмена сообщениями, известную как DORA:  
– **DHCPDISCOVER** — клиент отправляет широковещательный запрос для поиска DHCP-сервера;  
– **DHCPOFFER** — сервер предлагает клиенту IP-адрес и параметры конфигурации;  
– **DHCPREQUEST** — клиент подтверждает запрос на использование предложенного адреса;  
– **DHCPACK** — сервер подтверждает выдачу адреса и фиксирует аренду.  
Данный механизм позволяет автоматически и централизованно управлять сетевой адресацией.

**4. В каких файлах обычно находятся настройки DHCP-сервера? За что отвечает каждый из файлов?**  
Для DHCP-сервера Kea основные настройки располагаются в каталоге `/etc/kea/`.  
Основные файлы:  
– `kea-dhcp4.conf` — основной конфигурационный файл DHCPv4, содержащий описание подсетей, пулов адресов и параметров, передаваемых клиентам;  
– `kea-dhcp-ddns.conf` — конфигурация службы DHCP-DDNS, отвечающей за динамическое обновление DNS-записей;  
– `tsig-keys.json` — файл с TSIG-ключами, используемыми для аутентификации DDNS-запросов;  
– файлы в `/var/lib/kea/` — содержат информацию о выданных арендах (leases).

**5. Что такое DDNS? Для чего применяется DDNS?**  
DDNS (Dynamic Domain Name System) — это механизм динамического обновления DNS-зон, позволяющий автоматически добавлять, изменять или удалять DNS-записи без ручного редактирования файлов зон. DDNS применяется для автоматического обновления DNS-записей при появлении или изменении сетевых параметров узлов, например при динамической выдаче IP-адресов DHCP-сервером.

**6. Какую информацию можно получить, используя утилиту ifconfig? Приведите примеры с использованием различных опций.**  
Утилита `ifconfig` позволяет получить информацию о сетевых интерфейсах системы, включая IP-адреса, маску подсети, MAC-адрес, состояние интерфейса и статистику передачи данных.  
Примеры использования:  
– `ifconfig` — вывод информации обо всех активных интерфейсах;  
– `ifconfig eth1` — отображение параметров конкретного интерфейса `eth1`;  
– `ifconfig -a` — вывод информации обо всех интерфейсах, включая неактивные;  
– `ifconfig eth1 down` — временное отключение интерфейса.

**7. Какую информацию можно получить, используя утилиту ping? Приведите примеры с использованием различных опций.**  
Утилита `ping` используется для проверки сетевой доступности узла и измерения задержек передачи пакетов. Она позволяет определить, доступен ли узел по сети, а также оценить качество соединения.  
Примеры использования:  
– `ping 192.168.1.1` — проверка доступности узла по IP-адресу;  
– `ping client.example.net` — проверка разрешения имени и доступности узла;  
– `ping -c 5 192.168.1.1` — отправка ровно 5 ICMP-пакетов;  
– `ping -i 0.5 192.168.1.1` — задание интервала между пакетами;  
– `ping -s 1024 192.168.1.1` — изменение размера ICMP-пакета.
