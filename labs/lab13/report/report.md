---
## Front matter
title: "Отчёт по лабораторной работе 13"
subtitle: "Настройка NFS"
author: "Элсаиед Адел"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение навыков настройки сервера NFS для удалённого доступа к ресурсам.

# Выполнение

## Настройка сервера и клиента NFSv4

1. На серверной виртуальной машине было установлено необходимое программное обеспечение для работы службы NFS. В процессе установки были установлены пакеты nfs-utils и все требуемые зависимости, что обеспечило готовность системы к развёртыванию сервера NFS.

   ![Установка пакетов nfs-utils на сервере](Screenshot_1.png){ #fig:001 width=80% }

2. На сервере был создан каталог /srv/nfs, предназначенный для использования в качестве корня экспортируемого дерева NFS. Каталог создан с параметром создания вложенных директорий, что гарантирует его наличие вне зависимости от состояния родительских каталогов.

   ![Создание каталога /srv/nfs](Screenshot_2.png){ #fig:002 width=80% }

3. В конфигурационном файле /etc/exports был указан экспортируемый каталог /srv/nfs с доступом только на чтение для всех узлов сети. Данная настройка обеспечивает возможность использования общего ресурса клиентами без возможности изменения его содержимого.

   ![Настройка файла /etc/exports](Screenshot_3.png){ #fig:003 width=80% }

4. Для экспортируемого каталога был задан корректный контекст безопасности SELinux, необходимый для работы службы NFS в системе с включённым механизмом мандатного контроля доступа.

5. После задания контекста безопасности была выполнена процедура применения настроек SELinux ко всем файлам и подкаталогам в каталоге /srv/nfs. В результате каталог был успешно подготовлен для использования службой NFS.

6. Служба сервера NFS была запущена и добавлена в автозагрузку операционной системы. Это обеспечивает автоматический запуск сервиса при каждом старте системы.

   ![Запуск и включение службы nfs-server](Screenshot_4.png){ #fig:004 width=80% }

7. Для обеспечения сетевого доступа к серверу NFS были настроены правила межсетевого экрана. Служба NFS была разрешена во временной и постоянной конфигурации, после чего выполнена перезагрузка правил межсетевого экрана.

8. На клиентской виртуальной машине было установлено программное обеспечение, необходимое для работы с файловыми системами NFS и подключения удалённых ресурсов.

9. На клиенте была выполнена проверка доступных экспортируемых ресурсов сервера. При первой попытке было зафиксировано сообщение об ошибке RPC, что связано с отсутствием разрешающих правил для необходимых служб в межсетевом экране сервера.

   После корректной настройки сетевых правил команда успешно отобразила список экспортируемых каталогов, включая /srv/nfs, что подтверждает доступность сервера NFS для клиента.

   ![Проверка экспортируемых ресурсов с клиента](Screenshot_5.png){ #fig:005 width=80% }

10. На сервере была временно остановлена служба межсетевого экрана. После этого при повторной попытке получения списка экспортируемых ресурсов на клиенте возникли ошибки подключения, что обусловлено блокировкой сетевых взаимодействий RPC, используемых протоколом NFS.

11. После повторного запуска службы межсетевого экрана доступ к экспортируемым ресурсам был восстановлен, и клиент вновь смог получить информацию о доступных каталогах.

12. На сервере был выполнен анализ задействованных сетевых служб, участвующих в процессе удалённого монтирования. Установлено, что в работе используются службы rpcbind, mountd и statd, функционирующие по протоколам TCP и UDP.

   ![Анализ задействованных RPC-служб](Screenshot_6.png){ #fig:006 width=80% }

13. В настройки межсетевого экрана сервера были добавлены службы rpc-bind и mountd. Изменения были сохранены в постоянной конфигурации и применены после перезагрузки правил, что обеспечило корректную работу механизма удалённого монтирования.

14. На клиентской системе повторно выполнена проверка экспортируемых ресурсов сервера. Команда успешно отобразила каталог /srv/nfs, что подтверждает корректность выполненной конфигурации сервера NFS.

## Монтирование NFS на клиенте

1. На клиенте был создан каталог /mnt/nfs, предназначенный для монтирования удалённого ресурса. После этого выполнено подключение экспортируемого каталога /srv/nfs с сервера в указанную точку монтирования.

2. Было выполнено подтверждение корректности подключения удалённого ресурса. В выводе системы указано, что файловая система смонтирована с типом nfs4, в режиме только для чтения, с указанием версии протокола, сетевых параметров и адресов сервера и клиента.

   ![Проверка состояния монтирования NFS](Screenshot_7.png){ #fig:007 width=80% }

3. Для автоматического подключения удалённого ресурса при загрузке операционной системы в файл /etc/fstab была добавлена запись, указывающая сервер, экспортируемый каталог, точку монтирования, тип файловой системы и параметр сетевой зависимости.

   В данной записи параметр _netdev указывает на необходимость выполнения монтирования только после инициализации сетевых интерфейсов, что предотвращает ошибки при загрузке системы.

4. Было проверено состояние системной цели remote-fs.target, отвечающей за подключение удалённых файловых систем. Цель находится в активном состоянии, что подтверждает корректную настройку автоматического монтирования.

5. После перезагрузки клиентской системы выполнена повторная проверка, которая показала, что удалённый ресурс NFS подключается автоматически и доступен без возникновения ошибок. Это свидетельствует о правильной конфигурации как серверной, так и клиентской части.

## Подключение каталогов к дереву NFS

1. На сервере был создан каталог `/srv/nfs/www`, предназначенный для подключения каталога с контентом веб-сервера в дерево NFS. Данный каталог используется как точка привязки для дальнейшего экспорта через NFS.

   ![Создание каталога /srv/nfs/www](Screenshot_8.png){ #fig:008 width=80% }

2. Каталог веб-сервера `/var/www` был подмонтирован в каталог `/srv/nfs/www` с использованием bind-монтирования. Это позволило отобразить содержимое веб-каталога в экспортируемом дереве NFS без дублирования данных.

   ![Bind-монтирование каталога /var/www](Screenshot_9.png){ #fig:009 width=80% }

3. На сервере была выполнена проверка содержимого каталога `/srv/nfs`. В результате установлено, что в нём корректно отображается каталог `www`, соответствующий содержимому веб-сервера.

4. На клиентской системе была выполнена проверка содержимого каталога `/mnt/nfs`. В каталоге отображается каталог `www`, что подтверждает корректную передачу структуры экспортируемого дерева NFS на клиент.

   ![Просмотр каталога /mnt/nfs на клиенте](Screenshot_10.png){ #fig:010 width=80% }

5. В конфигурационный файл `/etc/exports` на сервере была добавлена запись для экспорта каталога `/srv/nfs/www` с правами чтения и записи для узлов сети `192.168.0.0/16`.

   ![Настройка экспорта каталога www](Screenshot_11.png){ #fig:011 width=80% }

6. После изменения файла `/etc/exports` была выполнена повторная публикация всех экспортируемых каталогов. В результате новые настройки экспорта были успешно применены.

7. На клиенте была выполнена повторная проверка каталога `/mnt/nfs`, которая подтвердила доступность каталога `www` и его корректное отображение после обновления настроек экспорта.

8. Для обеспечения постоянного bind-монтирования каталога веб-сервера при загрузке системы в файл `/etc/fstab` на сервере была добавлена запись, связывающая `/var/www` с `/srv/nfs/www`.

   ![Запись bind-монтирования в /etc/fstab](Screenshot_12.png){ #fig:012 width=80% }

9. После внесения изменений в файл `/etc/fstab` была повторно выполнена публикация экспортируемых каталогов, что обеспечило сохранение конфигурации после перезагрузки системы.

10. На клиентской системе выполнена итоговая проверка каталога `/mnt/nfs`, которая показала, что каталог `www` доступен и корректно смонтирован.

## Подключение каталогов для работы пользователей

1. На сервере под пользователем *elsaiedadel* в домашнем каталоге был создан каталог `common` с правами доступа `700`, что обеспечивает полный доступ только владельцу каталога. Внутри каталога был создан файл `elsaiedadel@server.net`.

   ![Создание пользовательского каталога common](Screenshot_13.png){ #fig:013 width=80% }

2. На сервере был создан каталог `/srv/nfs/home/elsaiedadel`, предназначенный для предоставления пользователю сетевого доступа к его рабочему каталогу.

3. Каталог `common` пользователя был подмонтирован в каталог `/srv/nfs/home/elsaiedadel` с использованием bind-монтирования. Права доступа каталога сохраняются и соответствуют правам исходного каталога — доступ разрешён только владельцу.

   ![Bind-монтирование пользовательского каталога](Screenshot_14.png){ #fig:014 width=80% }

4. В файл `/etc/exports` была добавлена запись для экспорта каталога `/srv/nfs/home/elsaiedadel` с правами чтения и записи для узлов сети `192.168.0.0/16`.

   ![Экспорт пользовательского каталога](Screenshot_15.png){ #fig:015 width=80% }

5. В файл `/etc/fstab` на сервере была добавлена запись для постоянного bind-монтирования каталога `/home/elsaiedadel/common` в каталог `/srv/nfs/home/elsaiedadel`, что обеспечивает автоматическое восстановление конфигурации при перезагрузке системы.

6. После внесения изменений в конфигурационные файлы была выполнена повторная публикация всех экспортируемых каталогов.

7. На клиентской системе выполнена проверка каталога `/mnt/nfs`. В каталоге корректно отображаются подкаталоги `home` и `www`, а также пользовательский каталог `elsaiedadel`.

   ![Проверка пользовательского каталога на клиенте](Screenshot_16.png){ #fig:016 width=80% }

8. На клиенте под пользователем *elsaiedadel* был выполнен переход в каталог `/mnt/nfs/home/elsaiedadel`, где успешно создан файл `elsaiedadel@client.net`. Это подтверждает наличие прав на запись для пользователя. При попытке выполнить аналогичные действия под пользователем root доступ был запрещён, что связано с установленными правами доступа и механизмами безопасности NFS.

9. На сервере была выполнена проверка каталога `/home/elsaiedadel/common`. В результате установлено, что файлы, созданные на клиенте, корректно отобразились на сервере, что подтверждает двустороннюю синхронизацию данных через NFS.

## Внесение изменений в настройки внутреннего окружения виртуальных машин

1. На виртуальной машине **server** выполнен переход в каталог `/vagrant/provision/server`, предназначенный для хранения файлов автоматической настройки внутреннего окружения. В данном каталоге был создан подкаталог `nfs/etc`, в который скопирован конфигурационный файл `/etc/exports`. Это позволило вынести конфигурацию NFS в provisioning-окружение Vagrant.

   ![Подготовка каталога provisioning на сервере](Screenshot_17.png){ #fig:017 width=80% }

2. В каталоге `/vagrant/provision/server` был создан исполняемый файл `nfs.sh`, предназначенный для автоматической настройки сервера NFS. Файлу были назначены права на выполнение, после чего он открыт для редактирования.

3. В скрипте `nfs.sh` были реализованы действия по установке необходимого программного обеспечения, копированию конфигурационных файлов NFS, применению контекстов SELinux, настройке межсетевого экрана, созданию каталогов NFS, bind-монтированию системных каталогов и запуску службы NFS. Скрипт обеспечивает полную автоматизацию настройки сервера при инициализации виртуальной машины.

   ![Скрипт автоматической настройки NFS на сервере](Screenshot_18.png){ #fig:018 width=80% }

4. На виртуальной машине **client** выполнен переход в каталог `/vagrant/provision/client`, предназначенный для размещения скриптов автоматической настройки клиентского окружения.

5. В каталоге `/vagrant/provision/client` был создан исполняемый файл `nfs.sh`, которому назначены права на выполнение. Скрипт предназначен для автоматической установки клиентского ПО NFS и подключения удалённого ресурса.

6. В скрипте `nfs.sh` на клиенте реализованы действия по установке пакета `nfs-utils`, созданию точки монтирования `/mnt/nfs`, монтированию удалённого ресурса с сервера и добавлению записи в файл `/etc/fstab` для обеспечения автоматического подключения ресурса при загрузке системы.

   ![Скрипт автоматической настройки NFS на клиенте](Screenshot_19.png){ #fig:019 width=80% }

7. Для обеспечения выполнения созданных provisioning-скриптов при запуске виртуальных машин в конфигурационный файл `Vagrantfile` были добавлены соответствующие директивы. Для виртуальной машины сервера подключён скрипт `provision/server/nfs.sh`, а для клиента — `provision/client/nfs.sh`. Параметр `preserve_order` обеспечивает корректную последовательность выполнения provisioning-скриптов.

   ![Подключение provisioning-скриптов в Vagrantfile](Screenshot_20.png){ #fig:020 width=80% }

8. В результате внесённых изменений настройка службы NFS на сервере и подключение удалённого ресурса на клиенте выполняются автоматически при запуске виртуальных машин, что обеспечивает воспроизводимость конфигурации и упрощает администрирование сетевого окружения.

# Вывод

В ходе выполнения лабораторной работы была выполнена настройка и эксплуатация сетевой файловой системы NFSv4 в виртуальной среде. Реализовано развёртывание сервера NFS и подключение клиентов с использованием экспортируемых каталогов, настроены параметры безопасности SELinux и правила межсетевого экрана. Выполнено подключение системных и пользовательских каталогов к дереву NFS, обеспечено разграничение прав доступа и проверена корректность двустороннего обмена данными между сервером и клиентом. Дополнительно реализована автоматизация настройки NFS с использованием provisioning-скриптов Vagrant, что обеспечило воспроизводимость конфигурации и автоматическое применение настроек при запуске виртуальных машин. Результаты работы подтверждают корректную настройку службы NFS и её готовность к использованию в сетевой среде.

# Контрольные вопросы

**1. Как называется файл конфигурации, содержащий общие ресурсы NFS?**  
Файл конфигурации, содержащий описание экспортируемых через NFS ресурсов и параметры доступа к ним, называется `/etc/exports`. В данном файле указываются каталоги, предоставляемые по сети, а также права доступа и ограничения для клиентов.

**2. Какие порты должны быть открыты в брандмауэре, чтобы обеспечить полный доступ к серверу NFS?**  
Для корректной работы сервера NFS необходимо разрешить сетевой доступ к службам NFS и связанным с ним RPC-сервисам. В частности, должны быть открыты порты, используемые службами `nfs`, `rpcbind` и `mountd`, которые работают поверх протоколов TCP и UDP. В среде с firewalld это достигается добавлением соответствующих сервисов в правила межсетевого экрана.

**3. Какую опцию следует использовать в /etc/fstab, чтобы убедиться, что общие ресурсы NFS могут быть установлены автоматически при перезагрузке?**  
Для обеспечения корректного автоматического монтирования ресурсов NFS при загрузке системы в файле `/etc/fstab` используется опция `_netdev`. Данная опция указывает системе выполнять монтирование только после инициализации сетевых интерфейсов, что предотвращает ошибки подключения удалённых файловых систем во время старта операционной системы.
