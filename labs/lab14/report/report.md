---
## Front matter
title: "Отчёт по лабораторной работе 14"
subtitle: "Настройка файловых служб Samba"
author: "Элсаиед Адел"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение навыков настройки доступа групп пользователей к общим ресурсам по протоколу SMB.

# Выполнение

## Настройка сервера Samba

1. На сервере установлены необходимые пакеты для работы файлового сервера Samba и клиентских утилит. Установка пакетов `samba`, `samba-client` и `cifs-utils` обеспечивает запуск демона SMB, возможность администрирования сервиса и проверку доступа к общим ресурсам с клиентской стороны.

2. Для управления правами доступа к разделяемым ресурсам создана группа `sambagroup` с фиксированным идентификатором `GID 1010`. Использование отдельной группы позволяет централизованно управлять пользователями, имеющими доступ к Samba-ресурсам.

3. Пользователь системы добавлен в группу `sambagroup`. Это необходимо для предоставления ему прав записи в каталог, который будет экспортироваться через Samba.

4. В файловой системе Linux создан каталог `/srv/sambashare`, предназначенный для размещения разделяемых данных. Каталог расположен в `/srv`, что соответствует стандартному назначению данного пути — хранение данных сетевых сервисов.

5. Выполнена настройка конфигурационного файла `/etc/samba/smb.conf`.  
   В секции `[global]` указано имя рабочей группы вида `USER-NET`, сформированное на основе логина пользователя.  
   В конец файла добавлен раздел `[sambashare]`, описывающий общий ресурс с путём `/srv/sambashare`. Для записи в данный ресурс разрешён доступ только пользователям, входящим в группу `sambagroup`.

   ![Настройка файла smb.conf и описание ресурса sambashare](Screenshot_1.png){ width=80% }

6. Синтаксис и корректность конфигурационного файла Samba проверены с помощью утилиты `testparm`. Ошибок в конфигурации не выявлено.

7. Выполнен запуск демона Samba и его добавление в автозагрузку системы. Это гарантирует автоматический запуск службы при каждой загрузке операционной системы.

8. Проверен статус службы `smb`. Служба находится в состоянии *active (running)*, что подтверждает её успешный запуск и готовность принимать подключения клиентов.

   ![Статус службы Samba](Screenshot_2.png){ width=80% }

9. Для проверки наличия и доступности общих ресурсов выполнено подключение к серверу с помощью `smbclient`. Подключение выполнено в анонимном режиме, после чего получен список доступных ресурсов, включая `sambashare`, что подтверждает корректную публикацию общего каталога.

   ![Проверка общих ресурсов с помощью smbclient](Screenshot_2.png){ width=80% }

10. Изучен файл описания сервиса Samba в межсетевом экране firewalld `/usr/lib/firewalld/services/samba.xml`. В конфигурации определены TCP-порты 139 и 445, используемые для работы протокола SMB.

   ![Файл конфигурации firewalld для сервиса Samba](Screenshot_3.png){ width=80% }

11. В межсетевом экране разрешён сервис Samba. Правило добавлено как во временную конфигурацию, так и в постоянную, после чего выполнена перезагрузка конфигурации firewalld.

12. Для каталога `/srv/sambashare` настроены права доступа: группой-владельцем назначена `sambagroup`, а участникам группы предоставлены права на чтение, запись и выполнение. Это позволяет членам группы создавать и изменять файлы в общем ресурсе.

13. Проверен текущий контекст безопасности SELinux для каталога `/srv`. На данном этапе каталог имел контекст, не предназначенный для использования Samba.

14. Для каталога общего ресурса настроен корректный SELinux-контекст `samba_share_t`. После добавления правила выполнено восстановление контекстов, в результате чего каталог получил корректную метку безопасности.

15. Повторная проверка контекста безопасности подтвердила успешное применение типа `samba_share_t` к каталогу `/srv/sambashare`.

   ![Контекст безопасности SELinux для sambashare](Screenshot_4.png){ width=80% }

16. В SELinux разрешён экспорт разделяемых ресурсов Samba в режиме чтения и записи путём установки соответствующего boolean-параметра. Настройка выполнена как временно, так и на постоянной основе.

17. Проверены UID пользователя и его принадлежность к группам. Вывод команды подтверждает, что пользователь входит в группу `sambagroup`, что необходимо для записи в общий каталог.

18. Под пользователем выполнена проверка записи в общий ресурс. В каталоге `/srv/sambashare` успешно создан тестовый файл, владельцем которого является пользователь, а группой — `sambagroup`. Это подтверждает корректность настроенных прав доступа и SELinux.

   ![Создание тестового файла в sambashare](Screenshot_5.png){ width=80% }

19. Пользователь добавлен в базу пользователей Samba. Для него задан пароль SMB-пользователя, что позволяет выполнять аутентифицированный доступ к ресурсу при подключении клиентов по протоколу SMB.

## Монтирование файловой системы Samba на клиенте

1. На клиентской системе установлены необходимые пакеты для работы с сетевыми ресурсами Samba. Установка `samba-client` и `cifs-utils` обеспечивает возможность просмотра общих ресурсов сервера и их монтирование в файловую систему клиента.

2. Выполнен просмотр файла конфигурации межсетевого экрана для клиента Samba `/usr/lib/firewalld/services/samba-client.xml`. В данном файле определены сетевые параметры и UDP-порт 138, используемый клиентской частью Samba.

   ![Файл конфигурации firewalld для samba-client](Screenshot_6.png){ width=80% }

3. На клиенте выполнена настройка межсетевого экрана: разрешён сервис `samba-client` во временной и постоянной конфигурации firewalld, после чего произведена перезагрузка правил. Это обеспечивает корректную работу клиентских подключений к серверу Samba.

   ![Настройка firewalld для samba-client](Screenshot_7.png){ width=80% }

4. Для корректного сопоставления прав доступа создана группа `sambagroup` с идентификатором `GID 1010`, после чего пользователь добавлен в данную группу. Это необходимо для работы с монтируемым ресурсом с правами записи.

5. В конфигурационном файле клиента `/etc/samba/smb.conf` в секции `[global]` изменён параметр рабочей группы на `ELSAIEADEL-NET`, что обеспечивает соответствие рабочей группе сервера Samba.

   ![Настройка рабочей группы в smb.conf на клиенте](Screenshot_8.png){ width=80% }

6. С клиента выполнена проверка наличия общих ресурсов на сервере с помощью `smbclient` без указания пользователя. Просмотр ресурсов осуществлялся под **анонимной учётной записью**, что подтверждается успешным анонимным входом и отображением списка общих ресурсов.

7. Повторно выполнен просмотр ресурсов сервера с указанием имени пользователя. В данном случае ресурсы просматривались под **учётной записью пользователя elsaiadedel**, что подтверждает корректную работу аутентифицированного доступа.

   ![Просмотр ресурсов сервера под учётной записью пользователя](Screenshot_9.png){ width=80% }

8. На клиентской системе создан каталог `/mnt/samba`, предназначенный для монтирования общего ресурса Samba.

9. Выполнено монтирование общего ресурса `//server/sambashare` в каталог `/mnt/samba` с указанием имени пользователя, идентификатора пользователя и группы `sambagroup`. В процессе был введён пароль SMB-пользователя. После монтирования ресурс отображается в списке смонтированных файловых систем типа `cifs`.

   ![Монтирование общего ресурса Samba](Screenshot_10.png){ width=80% }

10. Под пользователем выполнена проверка записи в смонтированный каталог. В каталоге `/mnt/samba` успешно создан тестовый файл `elsaiadedel@client.txt`, что подтверждает наличие прав записи на разделяемом ресурсе.

    ![Создание файла на смонтированном ресурсе Samba](Screenshot_11.png){ width=80% }

11. После проверки каталог `/mnt/samba` был корректно отмонтирован, что завершило тест ручного монтирования ресурса.

12. Для автоматического монтирования ресурса с использованием файла учётных данных на клиенте создан файл `/etc/samba/smbusers`. Файл содержит имя пользователя и пароль SMB и имеет права доступа, исключающие чтение другими пользователями.

    ![Файл учётных данных smbusers](Screenshot_12.png){ width=80% }

13. В файл `/etc/fstab` добавлена строка для автоматического монтирования ресурса `//server/sambashare` в каталог `/mnt/samba` с использованием CIFS, указанием пользователя, группы `sambagroup` и файла учётных данных. Использование параметра `_netdev` гарантирует монтирование после инициализации сети.

    ![Настройка автоматического монтирования в fstab](Screenshot_13.png){ width=80% }

14. Выполнено монтирование всех файловых систем, описанных в `/etc/fstab`. Проверка вывода смонтированных ресурсов подтверждает успешное автоматическое подключение Samba-ресурса и его доступность для пользователя.

    ![Проверка смонтированных ресурсов Samba](Screenshot_14.png){ width=80% }

15. Полученный результат подтверждает, что общий ресурс Samba корректно монтируется на клиенте как вручную, так и автоматически при загрузке системы, а пользователь имеет полный доступ к разделяемым данным.

## Внесение изменений в настройки внутреннего окружения виртуальных машин

1. На виртуальной машине **server** выполнен переход в каталог `/vagrant/provision/server`, предназначенный для хранения provisioning-скриптов. В данном каталоге создана структура `smb/etc/samba`, в которую скопирован конфигурационный файл Samba `smb.conf`. Это позволяет хранить эталонную конфигурацию сервиса и использовать её при автоматической инициализации виртуальной машины.

   ![Подготовка каталога provisioning и копирование smb.conf на сервере](Screenshot_15.png){ width=80% }

2. В каталоге `/vagrant/provision/server` создан исполняемый файл `smb.sh`. В данный файл внесён provisioning-скрипт, автоматизирующий настройку Samba-сервера. Скрипт выполняет установку необходимых пакетов, копирование конфигурационных файлов Samba, настройку межсетевого экрана, создание группы `sambagroup`, добавление пользователя в группу, регистрацию пользователя в базе Samba, создание общего каталога `/srv/sambashare`, настройку прав доступа и SELinux-контекстов, а также запуск и включение службы `smb` в автозагрузку.

   ![Provisioning-скрипт smb.sh для сервера](Screenshot_16.png){ width=80% }

3. На виртуальной машине **client** выполнен переход в каталог `/vagrant/provision/client`. Аналогично серверу создана структура каталогов `smb/etc/samba`, в которую скопированы конфигурационные файлы `smb.conf` и файл учётных данных `smbusers`. Это необходимо для автоматической настройки клиента Samba при загрузке виртуальной машины.

   ![Подготовка каталога provisioning и конфигурационных файлов на клиенте](Screenshot_17.png){ width=80% }

4. В каталоге `/vagrant/provision/client` создан исполняемый файл `smb.sh`, содержащий provisioning-скрипт для клиента Samba. Скрипт выполняет установку клиентских пакетов Samba, копирование конфигурационных файлов, настройку межсетевого экрана для сервиса `samba-client`, создание группы `sambagroup`, добавление пользователя в группу, создание точки монтирования `/mnt/samba` и настройку автоматического монтирования общего ресурса `//server/sambashare` через файл `/etc/fstab` с использованием файла учётных данных.

   ![Provisioning-скрипт smb.sh для клиента](Screenshot_18.png){ width=80% }

5. Для обеспечения автоматического выполнения созданных provisioning-скриптов при запуске виртуальных машин в конфигурационном файле `Vagrantfile` добавлены соответствующие секции. Для виртуальной машины **server** подключён скрипт `provision/server/smb.sh`, а для виртуальной машины **client** — скрипт `provision/client/smb.sh`. Использование параметра `preserve_order: true` гарантирует корректную последовательность выполнения сценариев инициализации.

6. В результате внесённых изменений настройка Samba-сервера и клиента полностью автоматизирована. При каждом запуске виртуальных машин выполняется установка пакетов, настройка сервисов, прав доступа, SELinux и автоматическое монтирование сетевого ресурса без необходимости ручного вмешательства администратора.

# Вывод

В ходе выполнения лабораторной работы была выполнена настройка и автоматизация файлового сервера Samba и клиентской системы в среде виртуализации. Реализована публикация общего ресурса, настройка аутентифицированного и анонимного доступа, управление правами на уровне пользователей, групп и SELinux, а также монтирование сетевого ресурса на клиенте вручную и автоматически при загрузке системы. Дополнительно была выполнена автоматизация всех этапов настройки с использованием provisioning-скриптов Vagrant, что обеспечило воспроизводимость конфигурации и исключило необходимость ручной настройки после запуска виртуальных машин. Проведённые проверки подтвердили корректность работы сервиса Samba, доступность ресурсов и возможность записи данных пользователями в соответствии с заданными политиками доступа.

# Контрольные вопросы

**1. Какова минимальная конфигурация для smb.conf для создания общего ресурса, который предоставляет доступ к каталогу /data?**  
Минимальная конфигурация файла `smb.conf` должна включать секцию `[global]` с указанием рабочей группы и секцию ресурса, описывающую каталог `/data`. В описании ресурса необходимо указать путь к каталогу и разрешить доступ. Даже при минимальной конфигурации рекомендуется явно задать параметры чтения и записи, чтобы избежать неоднозначного поведения сервиса.

**2. Как настроить общий ресурс, который даёт доступ на запись всем пользователям, имеющим права на запись в файловой системе Linux?**  
Для этого в настройках ресурса Samba необходимо разрешить запись (`read only = no` или `writable = yes`) и не ограничивать список пользователей или групп. Контроль доступа в этом случае будет осуществляться на уровне прав файловой системы Linux, то есть записывать данные смогут только те пользователи, у которых есть соответствующие права на каталог в Linux.

**3. Как ограничить доступ на запись к ресурсу только членам определённой группы?**  
Для ограничения доступа используется параметр `write list`, в котором указывается группа пользователей с префиксом `@`. Дополнительно необходимо, чтобы каталог в файловой системе Linux принадлежал этой группе и имел права на запись для группы. Таким образом, доступ на запись будет разрешён только членам указанной группы.

**4. Какой переключатель SELinux нужно использовать, чтобы позволить пользователям получать доступ к домашним каталогам на сервере через SMB?**  
Для этого используется SELinux boolean `samba_enable_home_dirs`. Его включение разрешает экспорт домашних каталогов пользователей через Samba с учётом настроенных прав доступа.

**5. Как ограничить доступ к определённому ресурсу только узлам из сети 192.168.10.0/24?**  
Ограничение доступа выполняется с помощью параметров `hosts allow` и `hosts deny` в описании ресурса Samba. В `hosts allow` указывается сеть `192.168.10.`, а в `hosts deny` — значение `ALL`. Это позволяет подключаться к ресурсу только узлам из заданной подсети.

**6. Какую команду можно использовать, чтобы отобразить список всех пользователей Samba на сервере?**  
Для просмотра списка пользователей Samba используется команда `pdbedit -L`. Она отображает всех зарегистрированных пользователей базы Samba и их основные атрибуты.

**7. Что нужно сделать пользователю для доступа к ресурсу, который настроен как многопользовательский ресурс?**  
Пользователь должен иметь учётную запись в системе Linux, быть добавленным в базу пользователей Samba и, при необходимости, входить в соответствующую группу. Также пользователю требуется знать пароль SMB-пользователя для аутентифицированного доступа к ресурсу.

**8. Как установить общий ресурс Samba в качестве многопользовательской учётной записи, где пользователь alice используется как минимальная учётная запись пользователя?**  
Для этого при монтировании ресурса используется параметр `multiuser`, а также указывается базовый пользователь (например, `alice`), от имени которого выполняется первичное подключение. Остальные пользователи могут подключаться к ресурсу, используя собственные учётные данные, при условии, что они зарегистрированы в Samba.

**9. Как можно запретить пользователям просматривать учётные данные монтирования Samba в файле /etc/fstab?**  
Для этого учётные данные выносятся в отдельный файл (например, `/etc/samba/smbusers`), на который устанавливаются права доступа `600`. В файле `/etc/fstab` указывается только путь к файлу с учётными данными, что предотвращает просмотр логинов и паролей другими пользователями.

**10. Какая команда позволяет перечислить все экспортируемые ресурсы Samba, доступные на определённом сервере?**  
Для просмотра списка экспортируемых ресурсов используется команда `smbclient -L //server`. Она позволяет получить перечень доступных общих ресурсов, а также информацию о режиме доступа и комментариях к ним.
