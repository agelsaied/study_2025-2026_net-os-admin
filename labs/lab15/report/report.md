---
## Front matter
title: "Отчёт по лабораторной работе 15"
subtitle: "Настройка сетевого журналирования"
author: "Элсаиед Адел"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Получение навыков по работе с журналами системных событий.

# Выполнение

## Настройка сервера и клиента сетевого журнала с использованием rsyslog

1. На серверной виртуальной машине в каталоге `/etc/rsyslog.d` был создан файл конфигурации сетевого хранения журналов `netlog-server.conf`. Данный файл предназначен для вынесения настроек приёма сетевых журналов в отдельный конфигурационный модуль rsyslog.

2. В файле `/etc/rsyslog.d/netlog-server.conf` была выполнена настройка приёма журналов по TCP-протоколу. С помощью директивы `$ModLoad imtcp` загружен модуль приёма сообщений по TCP, а директива `$InputTCPServerRun 514` активирует прослушивание стандартного порта 514 для сетевого журналирования.

   ![Настройка приёма журналов по TCP](Screenshot_1.png){ #fig:002 width=80% }

3. После внесения изменений служба rsyslog была перезапущена. Для проверки корректности запуска сервиса и подтверждения факта прослушивания сетевого порта выполнен анализ активных TCP-соединений. В выводе зафиксировано, что процесс `rsyslogd` находится в состоянии LISTEN на TCP-порту 514, что подтверждает успешную активацию сетевого приёма журналов.

4. Для обеспечения доступа клиентов к серверу сетевого журнала была выполнена настройка межсетевого экрана. TCP-порт 514 был открыт как временно, так и на постоянной основе, что обеспечивает приём сетевых журналов после перезагрузки системы.

   ![Настройка межсетевого экрана для TCP 514](Screenshot_2.png){ #fig:004 width=80% }

## Настройка клиента сетевого журнала

5. На клиентской виртуальной машине в каталоге `/etc/rsyslog.d` был создан файл конфигурации `netlog-client.conf`, предназначенный для настройки перенаправления журналов на удалённый сервер.

6. В файле `/etc/rsyslog.d/netlog-client.conf` была добавлена директива `*.* @@server.elsaiedadel.net:514`, которая обеспечивает отправку всех сообщений журналов по TCP-протоколу на сервер сетевого журнала. Использование двойного символа `@@` гарантирует надёжную доставку сообщений.

   ![Настройка пересылки журналов на сервер](Screenshot_3.png){ #fig:006 width=80% }

7. После внесения изменений служба rsyslog на клиенте была перезапущена. В результате клиентская система начала передачу системных сообщений на сервер сетевого журналирования.

## Просмотр и анализ журналов

8. На сервере был выполнен просмотр файла системных сообщений `/var/log/messages`. В процессе наблюдения за журналом были зафиксированы записи, поступающие как от сервера, так и от клиента. В сообщениях отображается имя хоста клиента и информация о работе системных служб, что подтверждает корректную настройку сетевого журналирования.

   ![Просмотр системных журналов на сервере](Screenshot_4.png){ #fig:007 width=80% }

9. Для анализа текущего состояния системы под пользовательской сессией была запущена графическая утилита мониторинга ресурсов. С её помощью выполнен просмотр списка активных процессов, загрузки процессора, использования оперативной памяти, сетевой активности и состояния файловых систем.

   ![Просмотр процессов системы](Screenshot_5.png){ #fig:008 width=80% }  
   ![Мониторинг ресурсов системы](Screenshot_6.png){ #fig:009 width=80% }  
   ![Состояние файловых систем](Screenshot_7.png){ #fig:010 width=80% }

10. Для расширенного анализа журналов предпринята попытка установки консольного просмотрщика системных сообщений `lnav`. В процессе установки получено сообщение об отсутствии пакета в доступных репозиториях, что указывает на необходимость подключения дополнительных источников программного обеспечения либо использования альтернативных средств анализа журналов.

   ![Ошибка установки lnav](Screenshot_8.png){ #fig:011 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальных машин

1. На виртуальной машине **server** выполнен переход в каталог `/vagrant/provision/server`, предназначенный для размещения provisioning-скриптов и конфигурационных файлов внутреннего окружения. В данном каталоге создана иерархия `netlog/etc/rsyslog.d`, в которую был скопирован файл конфигурации сетевого журнала сервера `netlog-server.conf`. Это обеспечивает централизованное хранение конфигурации и возможность её автоматического применения при развертывании виртуальной машины.

   ![Подготовка конфигурации netlog на сервере](Screenshot_9.png){ #fig:012 width=80% }

2. В каталоге `/vagrant/provision/server` создан исполняемый файл `netlog.sh`, предназначенный для автоматизации настройки сетевого журналирования на сервере. Файл был помечен как исполняемый и отредактирован. В скрипте реализованы операции копирования конфигурационных файлов в системный каталог `/etc`, восстановления контекста SELinux, настройки межсетевого экрана для TCP-порта 514 и перезапуска службы rsyslog.

   ![Provisioning-скрипт netlog.sh для сервера](Screenshot_10.png){ #fig:013 width=80% }

3. На виртуальной машине **client** выполнен переход в каталог `/vagrant/provision/client`. Аналогично серверу, была создана структура каталогов `netlog/etc/rsyslog.d`, в которую скопирован файл конфигурации клиента `netlog-client.conf`. Данная структура используется для автоматического применения клиентских настроек сетевого журналирования.

   ![Подготовка конфигурации netlog на клиенте](Screenshot_11.png){ #fig:014 width=80% }

4. В каталоге `/vagrant/provision/client` создан исполняемый provisioning-скрипт `netlog.sh`. Скрипт содержит команды для установки дополнительных пакетов, включая просмотрщик журналов, копирования конфигурационных файлов в каталог `/etc`, восстановления контекста безопасности SELinux и перезапуска службы rsyslog. Это обеспечивает корректную инициализацию клиента при каждой загрузке виртуальной машины.

   ![Provisioning-скрипт netlog.sh для клиента](Screenshot_12.png){ #fig:015 width=80% }

5. Для автоматического выполнения созданных provisioning-скриптов во время запуска виртуальных машин были внесены изменения в конфигурационный файл `Vagrantfile`. В разделы конфигурации виртуальных машин **server** и **client** добавлены инструкции shell-провижининга с указанием путей к соответствующим скриптам `netlog.sh` и сохранением порядка выполнения. Это обеспечивает автоматическую настройку сетевого журналирования при каждом развертывании окружения.

# Вывод

В ходе выполнения лабораторной работы была выполнена настройка централизованного сетевого журналирования на базе службы rsyslog в клиент-серверной архитектуре. Реализован приём системных сообщений по TCP-протоколу на сервере и их перенаправление с клиентской виртуальной машины. Дополнительно выполнена автоматизация настройки внутреннего окружения виртуальных машин с использованием provisioning-скриптов Vagrant, что обеспечило воспроизводимость конфигурации при каждом запуске виртуальных машин. Проверка журналов подтвердила корректную передачу и обработку сообщений, а также возможность централизованного мониторинга состояния сервисов и системы в целом.

# Контрольные вопросы

**1. Какой модуль rsyslog вы должны использовать для приёма сообщений от journald?**  
Для приёма сообщений от journald в rsyslog используется модуль `imjournal`. Данный модуль обеспечивает прямое взаимодействие rsyslog с systemd-journald и позволяет получать сообщения из бинарного журнала systemd без промежуточных файлов.

**2. Как называется устаревший модуль, который можно использовать для включения приёма сообщений журнала в rsyslog?**  
Устаревшим модулем для приёма сообщений журнала является `imuxsock`. Он осуществляет приём сообщений через UNIX-сокет `/dev/log`, однако не обеспечивает полного и корректного взаимодействия с journald, поэтому в современных системах рекомендуется использовать `imjournal`.

**3. Чтобы убедиться, что устаревший метод приёма сообщений из journald в rsyslog не используется, какой дополнительный параметр следует использовать?**  
Для исключения использования устаревшего метода необходимо использовать параметр `SystemLogSocketName=` в конфигурации journald, установив его в пустое значение. Это предотвращает передачу сообщений через сокет `/dev/log` и исключает использование модуля `imuxsock`.

**4. В каком конфигурационном файле содержатся настройки, которые позволяют вам настраивать работу журнала?**  
Основные настройки работы системного журнала journald содержатся в конфигурационном файле `/etc/systemd/journald.conf`. В нём задаются параметры хранения журналов, их ротации и пересылки сообщений в rsyslog.

**5. Каким параметром управляется пересылка сообщений из journald в rsyslog?**  
Пересылка сообщений из journald в rsyslog управляется параметром `ForwardToSyslog` в файле `/etc/systemd/journald.conf`. При значении `yes` сообщения передаются в rsyslog, при `no` — пересылка отключается.

**6. Какой модуль rsyslog вы можете использовать для включения сообщений из файла журнала, не созданного rsyslog?**  
Для чтения и обработки сообщений из файла журнала, не созданного rsyslog, используется модуль `imfile`. Он позволяет отслеживать произвольные текстовые файлы и включать их содержимое в систему журналирования.

**7. Какой модуль rsyslog вам нужно использовать для пересылки сообщений в базу данных MariaDB?**  
Для пересылки сообщений в базу данных MariaDB используется модуль `ommysql`. Он обеспечивает запись сообщений rsyslog в таблицы базы данных MySQL/MariaDB для последующего анализа и хранения.

**8. Какие две строки вам нужно включить в rsyslog.conf, чтобы позволить текущему журнальному серверу получать сообщения через TCP?**  
Для приёма сообщений через TCP необходимо загрузить модуль TCP и активировать серверный порт:
- строка загрузки модуля приёма TCP-сообщений;
- строка запуска TCP-сервера на порту 514.  
Эти директивы позволяют rsyslog принимать сетевые журналы по TCP-протоколу.

**9. Как настроить локальный брандмауэр, чтобы разрешить приём сообщений журнала через порт TCP 514?**  
Для разрешения приёма сообщений журнала необходимо открыть TCP-порт 514 в настройках межсетевого экрана. Порт добавляется в активную конфигурацию и фиксируется в постоянных правилах брандмауэра, чтобы разрешение сохранялось после перезагрузки системы.

